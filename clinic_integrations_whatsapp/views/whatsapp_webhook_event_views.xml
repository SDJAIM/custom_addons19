<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <!-- Tree view for webhook events -->
    <record id="view_whatsapp_webhook_event_tree" model="ir.ui.view">
        <field name="name">clinic.whatsapp.webhook.event.tree</field>
        <field name="model">clinic.whatsapp.webhook.event</field>
        <field name="arch" type="xml">
            <list string="WhatsApp Webhook Events"
                  decoration-success="processing_result=='success'"
                  decoration-warning="processing_result=='duplicate'"
                  decoration-danger="processing_result=='error'"
                  create="false"
                  edit="false">
                <field name="event_id"/>
                <field name="event_type"/>
                <field name="from_number"/>
                <field name="message_id"/>
                <field name="processed_at"/>
                <field name="processing_result" widget="badge"
                       decoration-success="processing_result=='success'"
                       decoration-warning="processing_result=='duplicate'"
                       decoration-danger="processing_result=='error'"/>
            </list>
        </field>
    </record>

    <!-- Form view for webhook events -->
    <record id="view_whatsapp_webhook_event_form" model="ir.ui.view">
        <field name="name">clinic.whatsapp.webhook.event.form</field>
        <field name="model">clinic.whatsapp.webhook.event</field>
        <field name="arch" type="xml">
            <form string="WhatsApp Webhook Event" create="false" edit="false">
                <header>
                    <field name="processing_result" widget="statusbar"/>
                </header>
                <sheet>
                    <div class="oe_title">
                        <h1>
                            <field name="event_id" readonly="1"/>
                        </h1>
                    </div>
                    <group>
                        <group>
                            <field name="event_type" readonly="1"/>
                            <field name="from_number" readonly="1"/>
                            <field name="message_id" readonly="1"/>
                        </group>
                        <group>
                            <field name="processed_at" readonly="1"/>
                            <field name="event_timestamp" readonly="1"/>
                            <field name="processing_result" readonly="1"/>
                        </group>
                    </group>
                    <notebook>
                        <page string="Payload" name="payload">
                            <field name="payload" readonly="1" widget="ace" options="{'mode': 'json'}"/>
                        </page>
                        <page string="Error" name="error" invisible="not error_message">
                            <group>
                                <field name="error_message" readonly="1" nolabel="1"/>
                            </group>
                        </page>
                    </notebook>
                </sheet>
            </form>
        </field>
    </record>

    <!-- Search view for webhook events -->
    <record id="view_whatsapp_webhook_event_search" model="ir.ui.view">
        <field name="name">clinic.whatsapp.webhook.event.search</field>
        <field name="model">clinic.whatsapp.webhook.event</field>
        <field name="arch" type="xml">
            <search>
                <field name="event_id"/>
                <field name="from_number"/>
                <field name="message_id"/>
                <separator/>
                <filter string="Messages" name="filter_messages"
                        domain="[('event_type', '=', 'message')]"/>
                <filter string="Status Updates" name="filter_status"
                        domain="[('event_type', '=', 'status')]"/>
                <separator/>
                <filter string="Success" name="filter_success"
                        domain="[('processing_result', '=', 'success')]"/>
                <filter string="Duplicates" name="filter_duplicate"
                        domain="[('processing_result', '=', 'duplicate')]"/>
                <filter string="Errors" name="filter_error"
                        domain="[('processing_result', '=', 'error')]"/>
                <separator/>
                <filter string="Today" name="filter_today"
                        domain="[('processed_at', '&gt;=', context_today().strftime('%Y-%m-%d 00:00:00'))]"/>
                <filter string="Last 7 Days" name="filter_week"
                        domain="[('processed_at', '&gt;=', (context_today() - datetime.timedelta(days=7)).strftime('%Y-%m-%d'))]"/>
                <separator/>
                <group>
                    <filter string="Event Type" name="group_event_type"
                            context="{'group_by': 'event_type'}"/>
                    <filter string="Result" name="group_result"
                            context="{'group_by': 'processing_result'}"/>
                    <filter string="Date" name="group_date"
                            context="{'group_by': 'processed_at:day'}"/>
                </group>
            </search>
        </field>
    </record>

    <!-- Action for webhook events -->
    <record id="action_whatsapp_webhook_event" model="ir.actions.act_window">
        <field name="name">Webhook Events</field>
        <field name="res_model">clinic.whatsapp.webhook.event</field>
        <field name="view_mode">tree,form</field>
        <field name="context">{'search_default_filter_today': 1}</field>
        <field name="help" type="html">
            <p class="o_view_nocontent_empty_folder">
                No webhook events yet
            </p>
            <p>
                Webhook events are logged here for debugging and audit purposes.
                This table ensures idempotency - duplicate webhooks from Meta are automatically detected and skipped.
            </p>
        </field>
    </record>

    <!-- Menu item (under WhatsApp > Technical) -->
    <menuitem id="menu_whatsapp_webhook_event"
              name="Webhook Events"
              parent="menu_whatsapp_technical"
              action="action_whatsapp_webhook_event"
              sequence="10"
              groups="base.group_system"/>
</odoo>

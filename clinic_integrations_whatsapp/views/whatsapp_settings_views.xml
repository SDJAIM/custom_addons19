<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <!-- WhatsApp Settings Configuration Form -->
    <record id="view_whatsapp_settings_form" model="ir.ui.view">
        <field name="name">WhatsApp Settings</field>
        <field name="model">clinic.whatsapp.settings</field>
        <field name="arch" type="xml">
            <form string="WhatsApp Settings">
                <div class="row mt16 o_settings_container">
                    <!-- API Configuration Section -->
                    <div class="col-12 col-lg-6 o_setting_box">
                        <div class="o_setting_left_pane">
                            <field name="id" invisible="1"/>
                        </div>
                        <div class="o_setting_right_pane">
                            <div class="row">
                                <label string="WhatsApp API Configuration" class="col-lg-3 o_light_label"/>
                                <div class="col-lg-9">
                                    <div class="text-muted">
                                        Configure your WhatsApp Business API credentials
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <label for="whatsapp_api_url" class="col-lg-3 o_light_label"/>
                                <field name="whatsapp_api_url" class="col-lg-9" placeholder="https://graph.facebook.com/v18.0"/>
                            </div>
                            <div class="row">
                                <label for="whatsapp_api_token" class="col-lg-3 o_light_label"/>
                                <field name="whatsapp_api_token" class="col-lg-9" password="True"
                                       placeholder="Your WhatsApp Business API Token"/>
                            </div>
                            <div class="row">
                                <label for="whatsapp_phone_number" class="col-lg-3 o_light_label"/>
                                <field name="whatsapp_phone_number" class="col-lg-9"
                                       placeholder="Phone Number ID from WhatsApp Business Manager"/>
                            </div>
                            <div class="row">
                                <label for="whatsapp_webhook_verify_token" class="col-lg-3 o_light_label"/>
                                <field name="whatsapp_webhook_verify_token" class="col-lg-9" password="True"
                                       placeholder="Webhook verification token"/>
                            </div>
                            <div class="row">
                                <label for="whatsapp_app_secret" class="col-lg-3 o_light_label"/>
                                <field name="whatsapp_app_secret" class="col-lg-9" password="True"
                                       placeholder="App secret for webhook signature verification"/>
                            </div>
                            <div class="row">
                                <div class="col-lg-9 offset-lg-3">
                                    <button name="action_test_connection" string="Test Connection"
                                            type="object" class="btn btn-secondary" icon="fa-plug"/>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Message Configuration Section -->
                    <div class="col-12 col-lg-6 o_setting_box">
                        <div class="o_setting_left_pane">
                        </div>
                        <div class="o_setting_right_pane">
                            <div class="row">
                                <label string="Message Configuration" class="col-lg-3 o_light_label"/>
                                <div class="col-lg-9">
                                    <div class="text-muted">
                                        Configure message handling and retry settings
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <label for="whatsapp_default_country_code" class="col-lg-3 o_light_label"/>
                                <field name="whatsapp_default_country_code" class="col-lg-9"/>
                            </div>
                            <div class="row">
                                <label for="whatsapp_max_retries" class="col-lg-3 o_light_label"/>
                                <field name="whatsapp_max_retries" class="col-lg-9"/>
                            </div>
                            <div class="row">
                                <label for="whatsapp_retry_delay" class="col-lg-3 o_light_label"/>
                                <field name="whatsapp_retry_delay" class="col-lg-9"/>
                            </div>
                        </div>
                    </div>

                    <!-- Feature Toggles Section -->
                    <div class="col-12 o_setting_box">
                        <div class="o_setting_left_pane">
                        </div>
                        <div class="o_setting_right_pane">
                            <div class="row">
                                <label string="Feature Configuration" class="col-lg-3 o_light_label"/>
                                <div class="col-lg-9">
                                    <div class="text-muted">
                                        Enable or disable WhatsApp features
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <label for="whatsapp_enable_reminders" class="col-lg-3 o_light_label"/>
                                <field name="whatsapp_enable_reminders" class="col-lg-9"/>
                            </div>
                            <div class="row">
                                <label for="whatsapp_enable_confirmations" class="col-lg-3 o_light_label"/>
                                <field name="whatsapp_enable_confirmations" class="col-lg-9"/>
                            </div>
                            <div class="row">
                                <label for="whatsapp_enable_prescription_reminders" class="col-lg-3 o_light_label"/>
                                <field name="whatsapp_enable_prescription_reminders" class="col-lg-9"/>
                            </div>
                            <div class="row">
                                <label for="whatsapp_enable_auto_responses" class="col-lg-3 o_light_label"/>
                                <field name="whatsapp_enable_auto_responses" class="col-lg-9"/>
                            </div>
                        </div>
                    </div>

                    <!-- Security Settings Section -->
                    <div class="col-12 o_setting_box">
                        <div class="o_setting_left_pane">
                        </div>
                        <div class="o_setting_right_pane">
                            <div class="row">
                                <label string="Security & Privacy" class="col-lg-3 o_light_label"/>
                                <div class="col-lg-9">
                                    <div class="text-muted">
                                        Configure security and privacy settings
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <label for="whatsapp_require_opt_in" class="col-lg-3 o_light_label"/>
                                <field name="whatsapp_require_opt_in" class="col-lg-9"/>
                            </div>
                            <div class="row">
                                <label for="whatsapp_webhook_enabled" class="col-lg-3 o_light_label"/>
                                <field name="whatsapp_webhook_enabled" class="col-lg-9"/>
                            </div>
                        </div>
                    </div>
                </div>
            </form>
        </field>
    </record>

    <!-- Action for WhatsApp Settings -->
    <record id="action_whatsapp_settings" model="ir.actions.act_window">
        <field name="name">WhatsApp Configuration</field>
        <field name="type">ir.actions.act_window</field>
        <field name="res_model">clinic.whatsapp.settings</field>
        <field name="view_mode">form</field>
        <field name="target">inline</field>
        <field name="context">{'module': 'clinic_integrations_whatsapp'}</field>
    </record>

    <!-- Menu item in Settings -->
    <menuitem id="menu_whatsapp_settings"
              name="WhatsApp Configuration"
              parent="base.menu_administration"
              action="action_whatsapp_settings"
              sequence="100"
              groups="base.group_system"/>

    <!-- Deprecated WhatsApp Config Migration View -->
    <record id="view_whatsapp_config_migration_form" model="ir.ui.view">
        <field name="name">WhatsApp Configuration Migration</field>
        <field name="model">clinic.whatsapp.config</field>
        <field name="arch" type="xml">
            <form string="WhatsApp Configuration (Deprecated)">
                <header>
                    <button name="migrate_to_config_params"
                            string="Migrate to Secure Storage"
                            type="object"
                            class="btn-primary"
                            attrs="{'invisible': [('migrated_to_config_params', '=', True)]}"/>
                    <field name="migrated_to_config_params" widget="badge"
                           decoration-success="migrated_to_config_params == True"/>
                </header>
                <sheet>
                    <div class="oe_button_box" name="button_box">
                    </div>
                    <div class="alert alert-warning" role="alert"
                         attrs="{'invisible': [('migrated_to_config_params', '=', True)]}">
                        <strong>⚠️ Security Notice:</strong> This configuration method is deprecated.
                        Please migrate to secure storage using the button above, then delete this record.
                    </div>
                    <div class="alert alert-success" role="alert"
                         attrs="{'invisible': [('migrated_to_config_params', '=', False)]}">
                        <strong>✅ Migration Complete:</strong> This configuration has been migrated to secure storage.
                        You can now safely delete this record.
                    </div>
                    <group>
                        <group>
                            <field name="name"/>
                            <field name="api_url"/>
                        </group>
                        <group>
                            <field name="api_token" password="True"/>
                            <field name="phone_number"/>
                        </group>
                    </group>
                </sheet>
            </form>
        </field>
    </record>

    <!-- Tree view for old configurations -->
    <record id="view_whatsapp_config_tree" model="ir.ui.view">
        <field name="name">WhatsApp Configuration Tree</field>
        <field name="model">clinic.whatsapp.config</field>
        <field name="arch" type="xml">
            <tree string="WhatsApp Configurations (Deprecated)">
                <field name="name"/>
                <field name="api_url"/>
                <field name="phone_number"/>
                <field name="migrated_to_config_params" widget="badge"
                       decoration-success="migrated_to_config_params == True"
                       decoration-warning="migrated_to_config_params == False"/>
                <field name="create_date"/>
            </tree>
        </field>
    </record>

    <!-- Action for old WhatsApp configs (for migration) -->
    <record id="action_whatsapp_config_migration" model="ir.actions.act_window">
        <field name="name">WhatsApp Configuration Migration</field>
        <field name="type">ir.actions.act_window</field>
        <field name="res_model">clinic.whatsapp.config</field>
        <field name="view_mode">tree,form</field>
        <field name="view_id" ref="view_whatsapp_config_tree"/>
        <field name="help">These are old WhatsApp configurations that should be migrated to secure storage.</field>
    </record>

    <!-- Migration menu (temporary, for admins) -->
    <menuitem id="menu_whatsapp_migration"
              name="WhatsApp Migration"
              parent="base.menu_administration"
              action="action_whatsapp_config_migration"
              sequence="101"
              groups="base.group_system"/>
</odoo>
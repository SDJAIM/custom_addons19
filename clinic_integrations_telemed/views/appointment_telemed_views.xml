<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <!-- Extend Appointment Form View with Telemedicine Integration -->
    <record id="view_clinic_appointment_form_telemed" model="ir.ui.view">
        <field name="name">clinic.appointment.form.telemed</field>
        <field name="model">clinic.appointment</field>
        <field name="inherit_id" ref="clinic_appointment_core.view_clinic_appointment_form"/>
        <field name="arch" type="xml">

            <!-- Add Telemedicine Buttons to Header -->
            <xpath expr="//header" position="inside">
                <!-- Setup Telemedicine Button (for non-telemed appointments) -->
                <button name="action_setup_telemedicine"
                        string="Setup Video Call"
                        type="object"
                        class="oe_highlight"
                        invisible="service_type == 'telemed' or has_telemed_session"
                        groups="clinic_staff.group_clinic_staff_user"
                        help="Convert to telemedicine appointment and create video session"/>

                <!-- Create Telemed Session (for telemed appointments without session) -->
                <button name="action_create_telemed_session"
                        string="Create Video Session"
                        type="object"
                        class="oe_highlight"
                        invisible="service_type != 'telemed' or has_telemed_session"
                        groups="clinic_staff.group_clinic_staff_user"/>

                <!-- Join Video Call (for active sessions) -->
                <button name="action_join_telemed_call"
                        string="Join Video Call"
                        type="object"
                        class="oe_highlight"
                        invisible="not has_telemed_session or telemed_session_state in ['draft', 'completed', 'cancelled']"
                        groups="clinic_staff.group_clinic_staff_user"/>
            </xpath>

            <!-- Add Alert for Telemedicine Appointments -->
            <xpath expr="//sheet" position="before">
                <div class="alert alert-info" role="alert"
                     invisible="service_type != 'telemed' or has_telemed_session">
                    <strong>Telemedicine Appointment</strong>
                    <p class="mb-0">
                        This is a video consultation. Click "Create Video Session" to set up the video call.
                    </p>
                </div>

                <div class="alert alert-success" role="alert"
                     invisible="not has_telemed_session or telemed_session_state != 'scheduled'">
                    <strong>Video Session Ready</strong>
                    <p class="mb-0">
                        Video call is scheduled. Click "Join Video Call" when it's time to start.
                    </p>
                </div>

                <div class="alert alert-warning" role="alert"
                     invisible="not has_telemed_session or telemed_session_state not in ['waiting', 'in_progress']">
                    <strong>Video Session Active</strong>
                    <p class="mb-0">
                        The video consultation is currently active. Click "Join Video Call" to participate.
                    </p>
                </div>
            </xpath>

            <!-- Add Telemedicine Fields after staff_id field -->
            <xpath expr="//field[@name='staff_id']" position="after">
                <field name="has_telemed_session" invisible="1"/>
                <field name="is_telemedicine_appointment" invisible="1"/>
                <field name="telemed_session_state" invisible="1"/>
                <field name="telemed_channel_id" invisible="1"/>
            </xpath>

        </field>
    </record>

    <!-- Extend Appointment Tree View with Telemedicine Icon -->
    <record id="view_clinic_appointment_tree_telemed" model="ir.ui.view">
        <field name="name">clinic.appointment.tree.telemed</field>
        <field name="model">clinic.appointment</field>
        <field name="inherit_id" ref="clinic_appointment_core.view_clinic_appointment_tree"/>
        <field name="arch" type="xml">

            <!-- Add Telemedicine Session State Column -->
            <xpath expr="//field[@name='state']" position="before">
                <field name="telemed_session_state" optional="show"
                       widget="badge"
                       decoration-info="telemed_session_state == 'scheduled'"
                       decoration-success="telemed_session_state == 'completed'"
                       decoration-warning="telemed_session_state in ['waiting', 'in_progress']"/>
            </xpath>

            <!-- Add hidden fields for filtering -->
            <xpath expr="//field[@name='state']" position="after">
                <field name="has_telemed_session" invisible="1"/>
                <field name="is_telemedicine_appointment" invisible="1"/>
            </xpath>

        </field>
    </record>

    <!-- Extend Appointment Search View with Telemedicine Filters -->
    <record id="view_clinic_appointment_search_telemed" model="ir.ui.view">
        <field name="name">clinic.appointment.search.telemed</field>
        <field name="model">clinic.appointment</field>
        <field name="inherit_id" ref="clinic_appointment_core.view_clinic_appointment_search"/>
        <field name="arch" type="xml">

            <!-- Add Telemedicine Filters -->
            <xpath expr="//filter[@name='confirmed']" position="after">
                <separator/>
                <filter string="Telemedicine" name="filter_telemedicine"
                        domain="[('service_type', '=', 'telemed')]"/>
                <filter string="Has Video Session" name="filter_has_video"
                        domain="[('has_telemed_session', '=', True)]"/>
                <filter string="Video Call Active" name="filter_video_active"
                        domain="[('telemed_session_state', 'in', ['waiting', 'in_progress'])]"/>
            </xpath>

        </field>
    </record>

</odoo>
